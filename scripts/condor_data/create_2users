#! /s/std/bin/perl

#  ========================================================================
#  DEVise Data Visualization Software
#  (c) Copyright 1999
#  By the DEVise Development Group
#  Madison, Wisconsin
#  All Rights Reserved.
#  ========================================================================
#
#  Under no circumstances is this software to be copied, distributed,
#  or altered in any way without prior permission from the DEVise
#  Development Group.

#  This script takes Condor data, already split by split_user_data,
#  and creates a DEVise session file that displays
#  each user's data as a view symbol.

#  Note: this script relies on there being a 'Total' user in the data.

############################################################

#  $Id$

#  $Log$
#  Revision 1.8  1999/07/23 20:37:50  wenger
#  Added disabling of user actions in relevant views.
#
#  Revision 1.7  1999/07/22 14:52:13  wenger
#  Updated Condor scripts for alignment info in mapping instead of view.
#
#  Revision 1.6  1999/07/15 19:26:42  wenger
#  Decreased font sizes for better appearance.
#
#  Revision 1.5  1999/06/30 17:39:11  wenger
#  Changed Condor session creation scripts because of new view symbol
#  color feature.
#
#  Revision 1.4  1999/06/04 20:53:35  wenger
#  Made total views view symbols so they line up with the other views;
#  fixed a few other minor problems.
#
#  Revision 1.3  1999/05/07 20:39:39  wenger
#  Made improvements to Condor user session scripts as requested by Miron.
#
#  Revision 1.2  1999/04/29 15:50:12  wenger
#  Changed HighLow symbols so that Y is the top rather than the middle (so
#  visual filter and home work better); changed Condor session scripts
#  accordingly.
#
#  Revision 1.1  1999/04/28 18:30:18  wenger
#  Split up data-splitting and session-creating parts of Condor session
#  scripts; made a new script to make a session with thumbnails for each
#  user; moved the scripts into scripts/condor.
#
#  Revision 1.8  1999/04/22 19:30:02  wenger
#  Separated the configuration of explicit (user-requested) and implicit
#  home actions (no GUI for configuring the implicit home); changed the
#  Condor user script accordingly; modified JavaScreen support so that this
#  all works for the JS.
#
#  Revision 1.7  1999/04/21 14:54:44  wenger
#  Text scaling in text symbols can be bypassed with negative width and
#  non-zero orientation (actually an unintentional affect of the previous
#  change); changed GUI and Condor user session script accordingly.
#
#  Revision 1.6  1999/04/20 13:46:10  wenger
#  Updated Condor user script as per Miron's changes to the session.
#
#  Revision 1.5  1999/04/16 20:59:30  wenger
#  Fixed various bugs related to view symbols, including memory problem
#  with MappingInterp dimensionInfo; updated create_condor_session script
#  to take advantage of view symbol TData switching capability.
#
#  Revision 1.4  1999/04/02 22:27:21  wenger
#  Modified session to allow comparison of two users, as per request from
#  Miron.
#
#  Revision 1.3  1999/03/24 22:05:21  wenger
#  Viewsyms now arranged vertically; added second window with user names.
#
#  Revision 1.2  1999/03/23 20:57:24  wenger
#  Session code checks for existance of data sources.
#
#  Revision 1.1  1999/03/23 20:31:16  wenger
#  First version -- still needs a little cleanup, but almost there.
#

############################################################

$debug = 0;

die "usage: create_2users <data directory> <session file>\n",
    "  <user list schema file> <data schema file>\n" if ($#ARGV != 3);

$data_dir = shift(@ARGV);
$session_file = shift(@ARGV);
$user_schema = shift(@ARGV);
$data_schema = shift(@ARGV);

# Find all of the users in the data file.
%userlist = ();
GetUsers();
@userarray = sort keys %userlist;
$usercount = $#userarray + 1;

# Create the session file.
CreateSession($session_file);

#-----------------------------------------------------------

sub GetUsers {

  open(DATA_IN, "${data_dir}/UserList") ||
      die "Couldn't open data file $data_file: $!\n";

  while ($line = <DATA_IN>) {
    print "line = $line" if ($debug);
    $tmpuser = GetUserFromLine($line);
    print "  tmpuser = $tmpuser\n" if ($debug);
    $userlist{$tmpuser} = 1;
  }
  print "\n" if ($debug);

  close(DATA_IN);
}

#-----------------------------------------------------------

sub GetUserFromLine {
  my $line = shift(@_);

  my @tmpuser = split(" ", $line);

  return $tmpuser[0];
}

#-----------------------------------------------------------

sub CreateSession {
  my $session_file = shift(@_);

  open(SES_OUT, ">$session_file") ||
      die "Can't create session_file $session_file: $!";

  #TEMP -- add std header??
  print SES_OUT "# DEVise session file created by create_condor_session\n\n";

  my $data_prefix = "Condor_";

  # Define data sources.
  DefineData($data_prefix);

  # Create views.
  CreateViews();

  # Create the mapping class and mappings.
  $mapClass = CreateMappings($data_prefix);

  # Insert mappings into views.
  InsertMappings($mapClass);

  # Create links and cursors and insert them into views.
  CreateLinksCursors();

  # Create the windows and insert the views into them.
  CreateWindows();

  # Force the visual filters to get updated when this session is opened.
  print SES_OUT "DEVise updateFilters\n";

  # Initialize views to show the full X range of data.
  print SES_OUT "DEVise viewGoHome Total_viewsym\n";
  print SES_OUT "DEVise waitForQueries\n";
  print SES_OUT "DEVise viewGoHome User1_viewsym\n";

  close(SES_OUT);
}

#-----------------------------------------------------------

sub DefineData {
  my $data_prefix = shift(@_);

  print SES_OUT "# Define data sources\n";

  use Cwd;
  $data_path = cwd() . "/$data_dir";

  # Create a data source for the top-level data (list of users).
  #TEMP -- name should probably be a variable
  my $dataName = $data_prefix . "UserList";
  my $dataFile = $top_level_file;

  #TEMP?
  my $schemaType = "CondorUserList";

  print SES_OUT "set errCode [catch {DEVise dteShowCatalogEntry .",
      "$dataName} oldEntry]\n";
  print SES_OUT "if {[llength \$oldEntry] <= 0} {\n";
  print SES_OUT "  DEVise dteInsertCatalogEntry . {\"$dataName\" UNIXFILE $dataFile $schemaType $user_schema \"\" 100 50 \"$data_path\" \"\"\} ;\n";
  print SES_OUT "}\n";

  #TEMP?
  $schemaType = "CondorUser";

  # Create a data source for each user's data.
  my $user;
  foreach $user (@userarray) {
    $dataName = $data_prefix . $user;
    $dataFile = $user . ".dat";

    print SES_OUT "set errCode [catch {DEVise dteShowCatalogEntry .",
        "$dataName} oldEntry]\n";
    print SES_OUT "if {[llength \$oldEntry] <= 0} {\n";
    print SES_OUT "DEVise dteInsertCatalogEntry . {\"$dataName\" UNIXFILE $dataFile $schemaType $data_schema \"\" 100 50 \"$data_path\" \"\"\} ;\n";
    print SES_OUT "}\n";
  }
}

#-----------------------------------------------------------

sub CreateViews {
  print SES_OUT "\n# Create views\n";

  print SES_OUT "DEVise create {view} {Scatter} UserList_view -0.05 1.05 0 1 36 9\n";
  print SES_OUT "DEVise viewSetImplicitHome {UserList_view} 0 1 1 1 0.55 0.55 0.0 0.0 ",
      "100.0 100.0\n";
  print SES_OUT "DEVise setViewAutoFilter UserList_view 1\n";
  print SES_OUT "DEVise viewSetDisabledActions UserList_view 1 0 0 1\n";
  print SES_OUT "\n";

  print SES_OUT "DEVise create {view} {Scatter} Select1_view 0 1 0 1 36 2\n";
  print SES_OUT "DEVise viewSetImplicitHome {Select1_view} 1 1 1 1 0.55 0.55 0.0 0.0 ",
      "100.0 100.0\n";
  print SES_OUT "DEVise setViewAutoFilter Select1_view 1\n";
  print SES_OUT "DEVise viewSetDisabledActions Select1_view 1 0 0 1\n";
  print SES_OUT "\n";

  print SES_OUT "DEVise create {view} {Scatter} Select2_view 0 1 0 1 36 9\n";
  print SES_OUT "DEVise viewSetImplicitHome {Select2_view} 1 1 1 1 0.55 0.55 0.0 0.0 ",
      "100.0 100.0\n";
  print SES_OUT "DEVise setViewAutoFilter Select2_view 1\n";
  print SES_OUT "DEVise viewSetDisabledActions Select2_view 1 0 0 1\n";
  print SES_OUT "\n";

  print SES_OUT "DEVise create {view} {Scatter} User1_view 0 1 -1 -2 36 2\n";
  $top = $usercount - 0.5;
  $bottom = $usercount - 1.5;
  print SES_OUT "DEVise viewSetImplicitHome {User1_view} 1 1 2 1 0.5 0.5 -0.5 ",
      "$bottom 0.5 $top\n";
  print SES_OUT "DEVise setViewAutoFilter User1_view 1\n";
  print SES_OUT "DEVise viewSetDisabledActions User1_view 1 1 1 1\n";
  print SES_OUT "\n";

  print SES_OUT "DEVise create {view} {Scatter} User2_view 0 1 -1 -2 36 9\n";
  $top = $usercount - 1.5;
  $bottom = $usercount - 2.5;
  print SES_OUT "DEVise viewSetImplicitHome {User2_view} 1 1 2 1 0.5 0.5 -0.5 ",
      "$bottom 0.5 $top\n";
  print SES_OUT "DEVise setViewAutoFilter User2_view 1\n";
  print SES_OUT "DEVise viewSetDisabledActions User2_view 1 1 1 1\n";
  print SES_OUT "\n";

  print SES_OUT "DEVise create {view} {Scatter} TotalLinked_view ",
      "-0.5 0.5 -0.5 0.5 36 9\n";
  print SES_OUT "DEVise viewSetDisabledActions TotalLinked_view 1 1 1 1\n";
  print SES_OUT "\n";

  print SES_OUT "DEVise create {view} {Scatter} Total_view ",
      "-0.5 0.5 -0.5 0.5 36 9\n";
  print SES_OUT "DEVise viewSetDisabledActions Total_view 1 1 1 1\n";
  print SES_OUT "\n";

  my @users;
  $users[0] = "User1";
  $users[1] = "User2";
  $users[2] = "TotalLinked";
  $users[3] = "Total";
  my %bgColor;
  $bgColor{$users[0]} = 2;
  $bgColor{$users[1]} = 9;
  $bgColor{$users[2]} = 9;
  $bgColor{$users[3]} = 9;
  my $user;
  foreach $user (@users) {
    # Create the view.
    print SES_OUT "DEVise create {view} {Scatter} ${user}_viewsym 0 1 0 1 36 $bgColor{$user}\n";

    # Force the bottom of the visual filter to be set to 0 on home.
    print SES_OUT "DEVise viewSetImplicitHome {${user}_viewsym} ",
      "0 1 1 1 0.0 0.0 0.0 0.0 100.0 100.0\n";
    print SES_OUT "DEVise viewSetHome {${user}_viewsym} ",
      "1 1 1 1 0.0 0.0 0.0 0.0 100.0 100.0\n";

    # Set this view for automatic filter updating.
    print SES_OUT "DEVise setViewAutoFilter ${user}_viewsym 1\n";

    # Turn on the X and Y axes.
    if ($user ne "User1" && $user ne "User2") {
      print SES_OUT "DEVise setAxisDisplay ${user}_viewsym {X} 1\n";
    }
    print SES_OUT "DEVise setAxisDisplay ${user}_viewsym {Y} 1\n";

    print SES_OUT "DEVise setXAxisDateFormat ${user}_viewsym {%b %d %H:%M}\n";

    print SES_OUT "DEVise setFont ${user}_viewsym {x axis} 0 10 0 0\n";
    print SES_OUT "DEVise setFont ${user}_viewsym {y axis} 0 10 0 0\n";

    print SES_OUT "\n";
  }

  print SES_OUT "DEVise viewSetDisabledActions Total_viewsym 1 0 0 1\n";
}

#-----------------------------------------------------------

sub CreateMappings {
  my $data_prefix = shift(@_);

  print SES_OUT "\n# Create mapping class\n";

  # Just use a single mapping class for all mappings.  Not the way
  # DEVise does it, but there doesn't seem to be any reason for
  # multiple mapping classes.
  my $mappingClass = "condor_user_mc";
  print SES_OUT "DEVise createMappingClass {$mappingClass}\n";

  print SES_OUT "\n# Create mappings\n";

  my $dataName = "${data_prefix}UserList";
  print SES_OUT "DEVise create {mapping} $mappingClass .$dataName ",
      "AllUser#$mappingClass {} {0} {\$X} {} 8 0.9 0 0 17 {\$ViewName} ",
      "1 1 {} {} {} {} {} {} {}\n";
  print SES_OUT "DEVise create {mapping} $mappingClass .$dataName ",
      "UserList#$mappingClass {} {0} {\$X} {} 37 0.9 0 360 12 {\$UserName} ",
      "{} {-2} {0.8} {} {-3} {4} {} {} {}\n";

  print SES_OUT "DEVise create {mapping} $mappingClass .$dataName ",
      "Select1#$mappingClass {} {0} {\$X} {} 8 0.5 0 0 0 1 1 ",
      "{} {} {} {} {} {} {} {}\n";
  print SES_OUT "DEVise create {mapping} $mappingClass .$dataName ",
      "Select2#$mappingClass {} {0} {\$X} {} 8 0.5 0 0 0 1 1 ",
      "{} {} {} {} {} {} {} {}\n";

  print SES_OUT "DEVise create {mapping} $mappingClass .$dataName ",
      "User1#$mappingClass {} {0} {\$X} {} {} 0.98 0 0 17 {\"User1_viewsym\"} 1 ",
      "1 {\$TDataName} {} {} {} {} {} {}\n";
  print SES_OUT "DEVise create {mapping} $mappingClass .$dataName ",
      "User2#$mappingClass {} {0} {\$X} {} {} 0.98 0 0 17 {\"User2_viewsym\"} 1 ",
      "1 {\$TDataName} {} {} {} {} {} {}\n";

  print SES_OUT "DEVise create {mapping} $mappingClass .$dataName ",
      "Total#$mappingClass {} {0} {\$X} {} {} 0.98 0 0 17 ",
	  "{\"Total_viewsym\"} 1 1 {} {} {} {} {} {} {}\n";

  print SES_OUT "DEVise create {mapping} $mappingClass .$dataName ",
      "TotalLinked#$mappingClass {} {0} {\$X} {} {} 0.98 0 0 17 ",
	  "{\"TotalLinked_viewsym\"} 1 1 {} {} {} {} {} {} {}\n";

  # Note: this is really a "dummy" TData for the User1 and User2 views --
  # it will get switched when the view symbol is drawn.
  $dataName = ".Condor_Total";
  print SES_OUT "DEVise create {mapping} $mappingClass .$dataName ",
      "User1sym#$mappingClass {} {\$time} {\$total_jobs} {} 31 1 0 0 8 1 ",
      "{\$jobs_running} {0} {5} {3} {} {} {} {} {}\n";
  print SES_OUT "DEVise create {mapping} $mappingClass .$dataName ",
      "User2sym#$mappingClass {} {\$time} {\$total_jobs} {} 31 1 0 0 8 1 ",
      "{\$jobs_running} {0} {5} {3} {} {} {} {} {}\n";
  print SES_OUT "DEVise create {mapping} $mappingClass .$dataName ",
      "Totalsym#$mappingClass {} {\$time} {\$total_jobs} {} 31 1 0 0 8 1 ",
      "{\$jobs_running} {0} {5} {3} {} {} {} {} {}\n";
  print SES_OUT "DEVise create {mapping} $mappingClass .$dataName ",
      "TotalLinkedsym#$mappingClass {} {\$time} {\$total_jobs} {} 31 1 0 0 8 1 ",
      "{\$jobs_running} {0} {5} {3} {} {} {} {} {}\n";

  return $mappingClass;
}

#-----------------------------------------------------------

sub InsertMappings {
  my $mappingClass = shift(@_);

  print SES_OUT "\n# Insert mappings into views\n";

  print SES_OUT "DEVise insertMapping {UserList_view} ",
      "{UserList#$mappingClass}\n";

  print SES_OUT "DEVise insertMapping {Select1_view} ",
      "{Select1#$mappingClass}\n";
  print SES_OUT "DEVise insertMapping {Select2_view} ",
      "{Select2#$mappingClass}\n";

  print SES_OUT "DEVise insertMapping {User1_view} ",
      "{User1#$mappingClass}\n";
  print SES_OUT "DEVise insertMapping {User2_view} ",
      "{User2#$mappingClass}\n";

  print SES_OUT "DEVise insertMapping {User1_viewsym} ",
      "{User1sym#$mappingClass}\n";
  print SES_OUT "DEVise insertMapping {User2_viewsym} ",
      "{User2sym#$mappingClass}\n";

  print SES_OUT "DEVise insertMapping {Total_viewsym} ",
      "{Totalsym#$mappingClass}\n";
  print SES_OUT "DEVise insertMapping {TotalLinked_viewsym} ",
      "{TotalLinkedsym#$mappingClass}\n";

  print SES_OUT "DEVise insertMapping {Total_view} ",
      "{Total#$mappingClass}\n";
  print SES_OUT "DEVise insertMapping {TotalLinked_view} ",
      "{TotalLinked#$mappingClass}\n";
}

#-----------------------------------------------------------

sub CreateLinksCursors {

  # Cursor to select first user to view.
  print SES_OUT "DEVise create {cursor} {Cursor} UserCursor1 2 1 1.000000 ",
      "1.000000\n";
  print SES_OUT "DEVise setCursorFixedSize UserCursor1 1\n";
  print SES_OUT "DEVise setCursorSrc {UserCursor1} {User1_view}\n";
  print SES_OUT "DEVise setCursorDst {UserCursor1} {Select1_view}\n";

  # Cursor to select second user to view.
  print SES_OUT "DEVise create {cursor} {Cursor} UserCursor2 2 1 1.000000 ",
      "1.000000\n";
  print SES_OUT "DEVise setCursorFixedSize UserCursor2 1\n";
  print SES_OUT "DEVise setCursorSrc {UserCursor2} {User2_view}\n";
  print SES_OUT "DEVise setCursorDst {UserCursor2} {Select2_view}\n";

  print SES_OUT "DEVise create {link} {Visual_Link} TimeLink 1\n";
  print SES_OUT "DEVise insertLink {TimeLink} {User1_viewsym}\n";
  print SES_OUT "DEVise insertLink {TimeLink} {User2_viewsym}\n";
  print SES_OUT "DEVise insertLink {TimeLink} {TotalLinked_viewsym}\n";

  # Cursor to select time range for user data.
  print SES_OUT "DEVise create {cursor} {Cursor} TimeCursor 1 0 1.000000 ",
      "1.000000\n";
  print SES_OUT "DEVise setCursorSrc {TimeCursor} {User1_viewsym}\n";
  print SES_OUT "DEVise setCursorDst {TimeCursor} {Total_viewsym}\n";
}

#-----------------------------------------------------------

sub CreateWindows {

  print SES_OUT "\n# Create windows and insert views\n";

  print SES_OUT "DEVise create {window} {TileLayout} UserList 0.10 0.20 ",
      "0.25 0.74 0 0\n";
  print SES_OUT "DEVise insertWindow {UserList_view} {UserList}\n";

  print SES_OUT "DEVise create {window} {TileLayout} Total 0.35 0.87 0.63 ",
      "0.07 0 0\n";
  print SES_OUT "DEVise insertWindow {Total_view} {Total}\n";

  print SES_OUT "DEVise create {window} {TileLayout} Select1 0.02 0.20 ",
      "0.04 0.74 0 0\n";
  print SES_OUT "DEVise insertWindow {Select1_view} {Select1}\n";

  print SES_OUT "DEVise create {window} {TileLayout} Select2 0.06 0.20 ",
      "0.04 0.74 0 0\n";
  print SES_OUT "DEVise insertWindow {Select2_view} {Select2}\n";

  print SES_OUT "DEVise create {window} {TileLayout} User1 0.35 0.20 0.63 ",
      "0.22 0 0\n";
  print SES_OUT "DEVise insertWindow {User1_view} {User1}\n";

  print SES_OUT "DEVise create {window} {TileLayout} User2 0.35 0.42 0.63 ",
      "0.22 0 0\n";
  print SES_OUT "DEVise insertWindow {User2_view} {User2}\n";

  print SES_OUT "DEVise create {window} {TileLayout} TotalLinked ",
      "0.35 0.64 0.63 0.23 0 0\n";
  print SES_OUT "DEVise insertWindow {TotalLinked_view} {TotalLinked}\n";
}

#-----------------------------------------------------------
