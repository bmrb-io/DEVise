#! /s/std/bin/perl

#  ========================================================================
#  DEVise Data Visualization Software
#  (c) Copyright 1999
#  By the DEVise Development Group
#  Madison, Wisconsin
#  All Rights Reserved.
#  ========================================================================
#
#  Under no circumstances is this software to be copied, distributed,
#  or altered in any way without prior permission from the DEVise
#  Development Group.

#  This script takes a file of Condor user data and splits it into separate
#  files for each user.

############################################################

#  $Id$

#  $Log$
#  Revision 1.3  1999/06/04 20:54:12  wenger
#  split_user_data script now takes output directory as a command-line
#  argument.
#
#  Revision 1.2  1999/05/07 20:39:40  wenger
#  Made improvements to Condor user session scripts as requested by Miron.
#
#  Revision 1.1  1999/04/28 18:30:33  wenger
#  Split up data-splitting and session-creating parts of Condor session
#  scripts; made a new script to make a session with thumbnails for each
#  user; moved the scripts into scripts/condor.
#

############################################################

$debug = 0;

die "usage: split_user_data <data file> <data directory>\n", if ($#ARGV != 1);

$data_file = shift(@ARGV);
$data_dir = shift(@ARGV);

open(DATA_IN, "$data_file") || die "Couldn't open data file $data_file: $!\n";


# Find all of the users listed in the data file.
%userlist = ();
GetUsers();
@userarray = reverse sort keys %userlist;


# Dump each user into the top-level data file.
mkdir $data_dir, 0755;

$top_level_file = "UserList";
UserTopLevel();


# Dump a data file for each user.
SplitUserData();


close(DATA_IN);

#-----------------------------------------------------------

sub GetUsers {
  while ($line = <DATA_IN>) {
    #TEMP? fix for columns running together
    $line =~ s/edu/edu /g;
    $line =~ s/Total/Total /g;

    print "line = $line" if ($debug);
    $tmpuser = GetUserFromLine($line);
    print "  tmpuser = $tmpuser\n" if ($debug);
    $userlist{$tmpuser} = 1;
  }
  print "\n" if ($debug);
}

#-----------------------------------------------------------

sub GetUserFromLine {
  my $line = shift(@_);

  # Note: assumes that timestamp is always 9 digits.
  my @tmpuser = split(" ", substr($line, 9));

  # Change dots in name to underscores because data source names cannot
  # contain dots.
  $tmpuser[0] =~ s/\./_/g;

  return $tmpuser[0];
}

#-----------------------------------------------------------

sub UserTopLevel {
  $userNum = 0;
  $outfile = $data_dir . "/" . $top_level_file;
  open(TOP_OUT, ">$outfile") || die "Can't create file $outfile: $!";
  foreach $user (@userarray) {
    print "User: $user\n" if ($debug);
    print TOP_OUT "$user\t.Condor_${user}\t${user}_view\t$userNum\t0\n";
    $userNum++;
  }
  close(TOP_OUT);
}

#-----------------------------------------------------------

sub SplitUserData {
  foreach $user (@userarray) {
    seek DATA_IN, 0, 0;

    $userfile = "$data_dir/" . $user . ".dat";
    open(USER_OUT, ">$userfile") || die "Can't create file $userfile: $!\n";

    while ($line = <DATA_IN>) {
      #TEMP? fix for columns running together
      $line =~ s/edu/edu /g;
      $line =~ s/Total/Total /g;

      if (GetUserFromLine($line) eq $user) {
        print "line = $line" if ($debug);
        print USER_OUT $line;
      }
    }
    close(USER_OUT);
  }
}

#-----------------------------------------------------------
