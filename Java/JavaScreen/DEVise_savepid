#! /bin/sh

############################################################

# Start devised for JavaScreen and save its PID.

# Note: this script should only be run by the DEVise.jspop
# script.

#-----------------------------------------------------------

# $Id$

############################################################

#
# Set output file name according to ID string (if any).
#
idStr=""
gotId=0
for arg in $*
do
  if [ $gotId = 1 ]
  then
    idStr=$arg
    gotId=0
  fi

  if [ $arg = "-id" ]
  then
    gotId=1
  fi
done

info=`ports+files $idStr`
outfile=`echo $info | cut -d' ' -f6`


#
# Set the various environment variables that the DEVise executable needs.
#
DEVISE_ROOT=/p/devise/demo
#DEVISE_ROOT=/p/devise/wenger
export DEVISE_ROOT

DEVISE_DAT=$DEVISE_ROOT/dat
export DEVISE_DAT
DEVISE_HOME_TABLE=$DEVISE_ROOT/schema/schema/catalog.js.dte
export DEVISE_HOME_TABLE
DEVISE_ID_FILE=$DEVISE_ROOT/schema/schema/temp_catalog.js
export DEVISE_ID_FILE
DEVISE_DEF_FILE=$DEVISE_ROOT/schema/schema/def_file.js
export DEVISE_DEF_FILE
DEVISE_INDEX_TABLE=$DEVISE_ROOT/schema/schema/sysind.js.dte
export DEVISE_INDEX_TABLE
DEVISE_MINMAX_TABLE=$DEVISE_ROOT/schema/schema/minmax.js.dte
export DEVISE_MINMAX_TABLE
DEVISE_MINMAX_DIR=$DEVISE_ROOT/dat
export DEVISE_MINMAX_DIR
DEVISE_MATER_DIR=$DEVISE_ROOT/dat
export DEVISE_MATER_DIR
DEVISE_CACHE=$DEVISE_ROOT/cache
export DEVISE_CACHE
DEVISE_SCHEMA=$DEVISE_ROOT/schema/schema
export DEVISE_SCHEMA
DEVISE_SESSION=$DEVISE_ROOT/session.js
export DEVISE_SESSION
DEVISE_PALETTE=$DEVISE_ROOT/palette
export DEVISE_PALETTE

DEVISE_TMP=/tmp/$USER-devise-tmp
export DEVISE_TMP
DEVISE_WORK=/tmp/$USER-devise-work
export DEVISE_WORK

DEVISE_LIB=lib
export DEVISE_LIB
DEVISE_EXEC=bin/devised
export DEVISE_EXEC


#
# Fire up the DEVise executable, creating the appropriate pid file, and
# deleting the pid file when DEVise exits.
#
$DEVISE_EXEC $* -logLevel 4 -jscache 1 >> $outfile 2>&1 &

host=`hostname`
pidfile="devised_pid:$idStr:$host:$!"
touch $pidfile
wait $!
rm $pidfile
