#! /s/std/bin/perl
#! /usr/freeware/bin/perl

#  ========================================================================
#  DEVise Data Visualization Software
#  (c) Copyright 1999-2001
#  By the DEVise Development Group
#  Madison, Wisconsin
#  All Rights Reserved.
#  ========================================================================
#
#  Under no circumstances is this software to be copied, distributed,
#  or altered in any way without prior permission from the DEVise
#  Development Group.

#  This script checks whether a jspop with the given ID string
#  are running.  If so, it prints "OK"; otherwise it prints "FAIL".

############################################################

#  $Id$

#  $Log$
#  Revision 1.18  2001/01/08 20:31:55  wenger
#  Merged all changes thru mgd_thru_dup_gds_fix on the js_cgi_br branch
#  back onto the trunk.
#
#  Revision 1.12.4.4  2000/12/27 19:38:36  wenger
#  Merged changes from js_restart_improvements thru zero_js_cache_check from
#  the trunk onto the js_cgi_br branch.
#
#  Revision 1.17  2000/12/18 20:28:15  wenger
#  Mods to get check/restart scripts to work at BMRB.
#
#  Revision 1.16  2000/12/13 22:02:03  wenger
#  Added more paths to perl.
#
#  Revision 1.12.4.3  2000/12/11 22:14:18  wenger
#  Merged chagnes from link_gui_improvements thru js_restart_improvements
#  onto the branch, removing imgport code from the restart scripts.
#
#  Revision 1.15  2000/12/08 20:54:59  wenger
#  Major changes to cron job scripts to check and restart jspop, etc., so they
#  work when jspop and jss are on different machines.
#
#  Revision 1.14  2000/12/06 21:42:58  wenger
#  Added ID string to .out files to avoid conflicts.
#
#  Revision 1.13  2000/12/06 19:52:10  wenger
#  Check scripts now have 'test' ID option, use new kill scripts; check_jss
#  starts 4 deviseds (for BMRB).
#
#  Revision 1.12.4.2  2000/11/15 16:11:02  wenger
#  Improved DEVise.kill, check* and run* scripts: added alternate path lines
#  for perl and csh; added 'test' id, other cleanups; added scripts to run
#  the JS with soil and test ports.
#
#  Revision 1.12.4.1  2000/11/13 18:10:30  wenger
#  Removed imgport arguments.
#
#  Revision 1.12  2000/05/02 18:27:43  wenger
#  Set up restart scripts for BMRB setup on yola/aden.
#
#  Revision 1.11  2000/04/17 20:15:49  wenger
#  Fixed up architecture check.
#
#  Revision 1.10  2000/04/17 20:01:15  wenger
#  Modified DEVise.kill, check_jspop, and run_check so that they work
#  on Linux as well as Solaris; changed pid-finding code in them to be
#  more reliable.
#
#  Revision 1.9  2000/02/18 22:21:16  wenger
#  Various changes to make cron scripts work better with new two-machine
#  setup: added -id argument to devise, jspop, jss; updated cron scripts
#  that check status of jspop, etc.; improved usage messages of jspop,
#  jss, js; improved DEVise.kill script; removed obsolete sections of
#  Java code.
#
#  Revision 1.8  1999/12/17 23:24:10  wenger
#  Improved scripts to automatically re-start jspops if necessary.
#
#  Revision 1.7  1999/12/10 20:15:21  wenger
#  Improved scripts now check separately for "regular" and "soil science"
#  jspop and deviseds.
#
#  Revision 1.6  1999/07/23 15:06:35  wenger
#  Okay, finally got args passed to jspop correctly.
#
#  Revision 1.5  1999/07/22 21:29:15  wenger
#  Typo in previous commit.
#
#  Revision 1.4  1999/07/22 21:25:01  wenger
#  Fixed problem with passing args to jspop.
#
#  Revision 1.3  1999/07/01 14:48:17  wenger
#  Added sleep after killing jspop and Xvfb to fix problem with the new Xvfb
#  sometimes starting before the old one is done being killed.
#
#  Revision 1.2  1999/06/30 18:23:10  wenger
#  check_jspop now causes jspop to run two deviseds; jspop script sleeps
#  after launching Xvfb.
#
#  Revision 1.1  1999/06/17 18:55:27  wenger
#  Fixed kill_devised2 script for problems with 'ps'; added check_jspop
#  script for restarting jspop if necessary.
#

############################################################

die "usage: check_jspop [idStr]\n" if ($#ARGV < -1 or $#ARGV > 0);

if ($#ARGV == 0) {
  $idStr = shift(@ARGV);
} else {
  $idStr = "";
}

$debug = 0;

print "idStr = $idStr\n" if ($debug);

$foundJspop = 0;


# One of the hardest parts of getting this script to work has been running
# ps in such a way that the port arguments still show up when the damn
# path to java gets real long.  -ww option to ps would guarantee that
# the line would be long enough, except that with the latest Intel/Solaris
# ps, this makes the command totally hang!!  RKW 1999-12-17.

$arch = `uname`;
chomp $arch;
if ($arch eq "Linux") {
  $ps_cmd = "/bin/ps axw";
} elsif (`hostname` eq "yola\n") {
  $ps_cmd = "/sbin/ps -ef";
} else {
  $ps_cmd = "/usr/ucb/ps -axw";
}

open PS, "$ps_cmd 2>/dev/null |" or die "can't fork: $!";

while (<PS>) {
  if ($idStr eq "") {
    if ($_ =~ /java *jspop/) {
      $foundJspop = 1;
    }
  } else {
    if ($_ =~ /java *jspop.*id$idStr/) {
      $foundJspop = 1;
    }
  }
}

close PS;


# Make sure we can connect to the jspop.
if ($foundJspop) {
  my $connected = 0;

  open CONNECT, "check_connect 2>check_connect.err |" or die "can't fork: $!";

  while (<CONNECT>) {
    if ($_ eq "OK\n") {
      $connected = 1;
    }
  }
  close CONNECT;

  if (!$connected) {
    print STDERR "Cannot connect to jspop\n";
    $foundJspop = 0;
  }
} else {
  print STDERR "No jspop process found\n";
}

print "foundJspop = $foundJspop\n" if ($debug);

$curTime = localtime(time());
if (!$foundJspop) {
  print STDERR "No jspop process found or cannot connect (at $curTime)\n";
}

if ($foundJspop) {
  print "OK\n";
} else {
  print "FAIL\n";
}
