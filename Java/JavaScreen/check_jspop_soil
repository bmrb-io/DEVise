#! /s/std/bin/perl

#  ========================================================================
#  DEVise Data Visualization Software
#  (c) Copyright 1999
#  By the DEVise Development Group
#  Madison, Wisconsin
#  All Rights Reserved.
#  ========================================================================
#
#  Under no circumstances is this software to be copied, distributed,
#  or altered in any way without prior permission from the DEVise
#  Development Group.

#  This is a script to check whether the jspop is running, and restart
#  it if it's not.

############################################################

#  $Id$

#  $Log$

############################################################

$foundJspop = 0;
$foundDevised = 0;

# Note: this is using Sun's (Solaris) ps -- mods may be required for other
# versions of ps.  RKW 1999-12-10.
open PS, "/bin/ps -e -o args >& 1 |" or die "can't fork: $!";

while (<PS>) {
  if ($_ =~ /java *jspop.*-cmdport5966/) {
    $foundJspop = 1;
  }
  if ($_ =~ /devised -port 59/) {
    $foundDevised = 1;
  }
}

close PS;


if (!$foundJspop) {
  $curTime = localtime(time());
  print "No jspop process found (at $curTime)\n";
  print "Restarting jspop\n";

  # Make sure we kill off any stray deviseds.
  system("kill_devised2 59");

  KillJspop();
  SaveLogs();

  StartJspop();
} elsif (!$foundDevised) {
  $curTime = localtime(time());
  print "No devised process found (at $curTime)\n";
  print "Restarting jspop\n";

  # If there are no deviseds running, that probably means there are problems
  # with the jspop, so kill it and start over.
  KillJspop();
  SaveLogs();

  StartJspop();
}

#-----------------------------------------------------------

sub SaveLogs {
  $timestamp = time();
  print "Saving log files as jspop.out.$timestamp and devised.out.$timestamp\n";

  # Perl's rename() function doesn't seem to work!?!
  @args = ("mv", "jspop.out", "jspop.out.$timestamp");
  0xffff & system(@args) == 0 or print "Can't rename jspop.out ($?)\n";

  @args = ("mv", "devised.out", "devised.out.$timestamp");
  0xffff & system(@args) == 0 or print "Can't rename devised.out ($?)\n";
}

#-----------------------------------------------------------

sub KillJspop {
  # Note: this is using Sun's (Solaris) ps -- mods may be required for other
  # versions of ps.  RKW 1999-12-10.
  open PS, "/bin/ps -e -o 'pid args' >& 1 |" or die "can't fork: $!";

  while (<PS>) {
    if ($_ =~ /java *jspop.*-cmdport5966/) {
      print "Killing $_";
      $foundJspop = 1;
      @words = split /  */, $_;
      $pid = @words[0];
      system("kill $pid");
    }
  }

  close PS;
}

#-----------------------------------------------------------

sub StartJspop {
  sleep 15;
  system("jspop -cmdport5966 -imgport5944 &");
}
