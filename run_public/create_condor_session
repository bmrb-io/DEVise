#! /s/std/bin/perl

#  ========================================================================
#  DEVise Data Visualization Software
#  (c) Copyright 1999
#  By the DEVise Development Group
#  Madison, Wisconsin
#  All Rights Reserved.
#  ========================================================================
#
#  Under no circumstances is this software to be copied, distributed,
#  or altered in any way without prior permission from the DEVise
#  Development Group.

#  This script takes a file of Condor user data, splits it into separate
#  files for each user, and creates a DEVise session file that displays
#  each user's data as a view symbol.

#  Note: this script relies on there being a 'Total' user in the data.

############################################################

#  $Id$

#  $Log$
#  Revision 1.4  1999/04/02 22:27:21  wenger
#  Modified session to allow comparison of two users, as per request from
#  Miron.
#
#  Revision 1.3  1999/03/24 22:05:21  wenger
#  Viewsyms now arranged vertically; added second window with user names.
#
#  Revision 1.2  1999/03/23 20:57:24  wenger
#  Session code checks for existance of data sources.
#
#  Revision 1.1  1999/03/23 20:31:16  wenger
#  First version -- still needs a little cleanup, but almost there.
#

############################################################

$debug = 0;

die "usage: create_condor_session <data file> <session file>\n",
    "  <user list schema file> <data schema file>\n" if ($#ARGV != 3);

$data_file = shift(@ARGV);
$session_file = shift(@ARGV);
$user_schema = shift(@ARGV);
$data_schema = shift(@ARGV);

open(DATA_IN, "$data_file") || die "Couldn't open data file $data_file: $!\n";


# Find all of the users listed in the data file.
%userlist = ();
GetUsers();


# Dump each user into the top-level data file.
$data_dir = "userdat";
mkdir $data_dir, 0755;

$top_level_file = "UserList";
UserTopLevel();


# Dump a data file for each user.
SplitUserData();


close(DATA_IN);


# Create the session file.
CreateSession($session_file);

#-----------------------------------------------------------

sub GetUsers {
  while ($line = <DATA_IN>) {
    print "line = $line" if ($debug);
    $tmpuser = GetUserFromLine($line);
    print "  tmpuser = $tmpuser\n" if ($debug);
    $userlist{$tmpuser} = 1;
  }
  print "\n" if ($debug);
}

#-----------------------------------------------------------

sub GetUserFromLine {
  my $line = shift(@_);

  # Note: assumes that timestamp is always 9 digits.
  my @tmpuser = split(" ", substr($line, 9));

  # Change dots in name to underscores because data source names cannot
  # contain dots.
  $tmpuser[0] =~ s/\./_/g;

  return $tmpuser[0];
}

#-----------------------------------------------------------

sub UserTopLevel {
  $userNum = 0;
  $outfile = $data_dir . "/" . $top_level_file;
  open(TOP_OUT, ">$outfile") || die "Can't create file $outfile: $!";
  foreach $user (sort keys %userlist) {
    print "User: $user\n" if ($debug);
    print TOP_OUT "$user\t.Condor_${user}\t${user}_view\t$userNum\t0\n";
    $userNum++;
  }
  close(TOP_OUT);
}

#-----------------------------------------------------------

sub SplitUserData {
  foreach $user (sort keys %userlist) {
    seek DATA_IN, 0, 0;

    $userfile = "$data_dir/" . $user . ".dat";
    open(USER_OUT, ">$userfile") || die "Can't create file $userfile: $!\n";

    while ($line = <DATA_IN>) {
      if (GetUserFromLine($line) eq $user) {
        print "line = $line" if ($debug);
        print USER_OUT $line;
      }
    }
    close(USER_OUT);
  }
}

#-----------------------------------------------------------

sub CreateSession {
  my $session_file = shift(@_);

  open(SES_OUT, ">$session_file") ||
      die "Can't create session_file $session_file: $!";

  #TEMP -- add std header??
  print SES_OUT "# DEVise session file created by create_condor_session\n\n";

  my $data_prefix = "Condor_";

  # Define data sources.
  DefineData($data_prefix);

  # Create views.
  CreateViews();

  # Create the mapping class and mappings.
  $mapClass = CreateMappings($data_prefix);

  # Insert mappings into views.
  InsertMappings($mapClass);

  # Create links and cursors and insert them into views.
  CreateLinksCursors();

  # Create the windows and insert the views into them.
  CreateWindows();

  # Force the visual filters to get updated when this session is opened.
  print SES_OUT "DEVise updateFilters\n";

  close(SES_OUT);
}

#-----------------------------------------------------------

sub DefineData {
  my $data_prefix = shift(@_);

  print SES_OUT "# Define data sources\n";

  use Cwd;
  $data_path = cwd() . "/$data_dir";

  # Create a data source for the top-level data (list of users).
  #TEMP -- name should probably be a variable
  my $dataName = $data_prefix . "UserList";
  my $dataFile = $top_level_file;

  #TEMP?
  my $schemaType = "CondorUserList";

  print SES_OUT "set errCode [catch {DEVise dteShowCatalogEntry .",
      "$dataName} oldEntry]\n";
  print SES_OUT "if {[llength \$oldEntry] <= 0} {\n";
  print SES_OUT "  DEVise dteInsertCatalogEntry . {\"$dataName\" UNIXFILE $dataFile $schemaType $user_schema \"\" 100 50 \"$data_path\" \"\"\} ;\n";
  print SES_OUT "}\n";

  #TEMP?
  $schemaType = "CondorUser";

  # Create a data source for each user's data.
  my $user;
  foreach $user (sort keys %userlist) {
    $dataName = $data_prefix . $user;
    $dataFile = $user . ".dat";

    print SES_OUT "set errCode [catch {DEVise dteShowCatalogEntry .",
        "$dataName} oldEntry]\n";
    print SES_OUT "if {[llength \$oldEntry] <= 0} {\n";
    print SES_OUT "DEVise dteInsertCatalogEntry . {\"$dataName\" UNIXFILE $dataFile $schemaType $data_schema \"\" 100 50 \"$data_path\" \"\"\} ;\n";
    print SES_OUT "}\n";
  }
}

#-----------------------------------------------------------

sub CreateViews {
  print SES_OUT "\n# Create views\n";

  print SES_OUT "DEVise create {view} {Scatter} UserList_view 0 1 0 1 36 1\n";
  print SES_OUT "DEVise viewSetHome {UserList_view} 1 1 1 1 0.55 0.55 0.0 0.0 ",
      "100.0 100.0\n";
  print SES_OUT "DEVise setViewAutoFilter UserList_view 1\n";
  print SES_OUT "\n";

  print SES_OUT "DEVise create {view} {Scatter} Select1_view 0 1 0 1 36 1\n";
  print SES_OUT "DEVise viewSetHome {Select1_view} 1 1 1 1 0.55 0.55 0.0 0.0 ",
      "100.0 100.0\n";
  print SES_OUT "DEVise setViewAutoFilter Select1_view 1\n";
  print SES_OUT "\n";

  print SES_OUT "DEVise create {view} {Scatter} Select2_view 0 1 0 1 36 1\n";
  print SES_OUT "DEVise viewSetHome {Select2_view} 1 1 1 1 0.55 0.55 0.0 0.0 ",
      "100.0 100.0\n";
  print SES_OUT "DEVise setViewAutoFilter Select2_view 1\n";
  print SES_OUT "\n";

  print SES_OUT "DEVise create {view} {Scatter} User1_view 0 1 -1 -2 36 1\n";
  print SES_OUT "DEVise viewSetHome {User1_view} 1 1 2 1 0.5 0.5 -0.5 0.5 ",
      "0.5 1.5\n";
  print SES_OUT "DEVise setViewAutoFilter User1_view 1\n";
  print SES_OUT "\n";

  print SES_OUT "DEVise create {view} {Scatter} User2_view 0 1 -1 -2 36 1\n";
  print SES_OUT "DEVise viewSetHome {User2_view} 1 1 2 1 0.5 0.5 -0.5 1.5 ",
      "0.5 2.5\n";
  print SES_OUT "DEVise setViewAutoFilter User2_view 1\n";
  print SES_OUT "\n";

  my @users;
  $users[0] = "User1";
  $users[1] = "User2";
  $users[2] = "Total";
  my $user;
  foreach $user (@users) {
    # Create the view.
    print SES_OUT "DEVise create {view} {Scatter} ${user}_viewsym 0 1 0 1 36 3\n";

    # Force the bottom of the visual filter to be set to 0 on home.
    print SES_OUT "DEVise viewSetHome {${user}_viewsym} 1 1 1 1 0.0 0.0 0.0 0.0 ",
      "100.0 100.0\n";

    # Set this view for automatic filter updating.
    print SES_OUT "DEVise setViewAutoFilter ${user}_viewsym 1\n";

    # Turn on the X and Y axes.
    print SES_OUT "DEVise setAxisDisplay ${user}_viewsym {X} 1\n";
    print SES_OUT "DEVise setAxisDisplay ${user}_viewsym {Y} 1\n";

    print SES_OUT "\n";
  }
}

#-----------------------------------------------------------

sub CreateMappings {
  my $data_prefix = shift(@_);

  print SES_OUT "\n# Create mapping class\n";

  # Just use a single mapping class for all mappings.  Not the way
  # DEVise does it, but there doesn't seem to be any reason for
  # multiple mapping classes.
  my $mappingClass = "condor_user_mc";
  print SES_OUT "DEVise createMappingClass {$mappingClass}\n";

  print SES_OUT "\n# Create mappings\n";

  my $dataName = "${data_prefix}UserList";
  print SES_OUT "DEVise create {mapping} $mappingClass .$dataName ",
      "AllUser#$mappingClass {} {0} {\$X} {} 8 0.9 0 0 17 {\$ViewName} ",
      "1 1 {} {} {} {} {} {} {}\n";
  print SES_OUT "DEVise create {mapping} $mappingClass .$dataName ",
      "UserList#$mappingClass {} {0} {\$X} {} 8 0.015 0 0 16 {\$UserName} ",
      "{} {} {} {} {} {} {} {} {}\n";

  print SES_OUT "DEVise create {mapping} $mappingClass .$dataName ",
      "Select1#$mappingClass {} {0} {\$X} {} 8 0.5 0 0 0 1 1 ",
      "{} {} {} {} {} {} {} {}\n";
  print SES_OUT "DEVise create {mapping} $mappingClass .$dataName ",
      "Select2#$mappingClass {} {0} {\$X} {} 8 0.5 0 0 0 1 1 ",
      "{} {} {} {} {} {} {} {}\n";

  print SES_OUT "DEVise create {mapping} $mappingClass .$dataName ",
      "User1#$mappingClass {} {0} {\$X} {} 8 0.9 0 0 17 {\"User1_viewsym\"} 1 ",
      "1 {\$TDataName} {} {} {} {} {} {}\n";
  print SES_OUT "DEVise create {mapping} $mappingClass .$dataName ",
      "User2#$mappingClass {} {0} {\$X} {} 8 0.9 0 0 17 {\"User2_viewsym\"} 1 ",
      "1 {\$TDataName} {} {} {} {} {} {}\n";

  # Note: this is really a "dummy" TData -- it will get switched when the
  # view symbol is drawn.
  $dataName = "Condor_Total";
  print SES_OUT "DEVise create {mapping} $mappingClass .$dataName ",
      "User1sym#$mappingClass {} {\$time} {\$jobs_running} {} 31 1 0 0 8 1 ",
      "{\$total_jobs} {0} {5} {3} {} {} {} {} {}\n";
  print SES_OUT "DEVise create {mapping} $mappingClass .$dataName ",
      "User2sym#$mappingClass {} {\$time} {\$jobs_running} {} 31 1 0 0 8 1 ",
      "{\$total_jobs} {0} {5} {3} {} {} {} {} {}\n";

  $dataName = "Condor_Total";
  print SES_OUT "DEVise create {mapping} $mappingClass .$dataName ",
      "Total#$mappingClass {} {\$time} {\$jobs_running} {} 31 1 0 0 8 1 ",
      "{\$total_jobs} {0} {5} {3} {} {} {} {} {}\n";

  return $mappingClass;
}

#-----------------------------------------------------------

sub InsertMappings {
  my $mappingClass = shift(@_);

  print SES_OUT "\n# Insert mappings into views\n";

  print SES_OUT "DEVise insertMapping {UserList_view} ",
      "{UserList#$mappingClass}\n";

  print SES_OUT "DEVise insertMapping {Select1_view} ",
      "{Select1#$mappingClass}\n";
  print SES_OUT "DEVise insertMapping {Select2_view} ",
      "{Select2#$mappingClass}\n";

  print SES_OUT "DEVise insertMapping {User1_view} ",
      "{User1#$mappingClass}\n";
  print SES_OUT "DEVise insertMapping {User2_view} ",
      "{User2#$mappingClass}\n";

#NEW
  print SES_OUT "DEVise insertMapping {User1_viewsym} ",
      "{User1sym#$mappingClass}\n";
  print SES_OUT "DEVise insertMapping {User2_viewsym} ",
      "{User2sym#$mappingClass}\n";

  print SES_OUT "DEVise insertMapping {Total_viewsym} ",
      "{Total#$mappingClass}\n";
}

#-----------------------------------------------------------

sub CreateLinksCursors {

  # Cursor to select first user to view.
  print SES_OUT "DEVise create {cursor} {Cursor} UserCursor1 2 1 1.000000 ",
      "1.000000\n";
  print SES_OUT "DEVise setCursorSrc {UserCursor1} {User1_view}\n";
  print SES_OUT "DEVise setCursorDst {UserCursor1} {Select1_view}\n";

  # Cursor to select second user to view.
  print SES_OUT "DEVise create {cursor} {Cursor} UserCursor2 2 1 1.000000 ",
      "1.000000\n";
  print SES_OUT "DEVise setCursorSrc {UserCursor2} {User2_view}\n";
  print SES_OUT "DEVise setCursorDst {UserCursor2} {Select2_view}\n";

  print SES_OUT "DEVise create {link} {Visual_Link} TimeLink 1\n";
  print SES_OUT "DEVise insertLink {TimeLink} {User1_viewsym}\n";
  print SES_OUT "DEVise insertLink {TimeLink} {User2_viewsym}\n";

  # Cursor to select time range for user data.
  print SES_OUT "DEVise create {cursor} {Cursor} TimeCursor 1 0 1.000000 ",
      "1.000000\n";
  print SES_OUT "DEVise setCursorSrc {TimeCursor} {User1_viewsym}\n";
  print SES_OUT "DEVise setCursorDst {TimeCursor} {Total_viewsym}\n";
}

#-----------------------------------------------------------

sub CreateWindows {

  print SES_OUT "\n# Create windows and insert views\n";

  print SES_OUT "DEVise create {window} {TileLayout} UserList 0.07 0.20 ",
      "0.23 0.60 0 0\n";
  print SES_OUT "DEVise insertWindow {UserList_view} {UserList}\n";

  print SES_OUT "DEVise create {window} {TileLayout} Total 0.02 0.84 0.96 ",
      "0.10 0 0\n";
  #TEMP -- maybe we should use a view symbol here
  print SES_OUT "DEVise insertWindow {Total_viewsym} {Total}\n";

  print SES_OUT "DEVise create {window} {TileLayout} Select1 0.02 0.20 ",
      "0.04 0.60 0 0\n";
  print SES_OUT "DEVise insertWindow {Select1_view} {Select1}\n";

  print SES_OUT "DEVise create {window} {TileLayout} Select2 0.31 0.20 ",
      "0.04 0.60 0 0\n";
  print SES_OUT "DEVise insertWindow {Select2_view} {Select2}\n";

  print SES_OUT "DEVise create {window} {TileLayout} User1 0.36 0.20 0.62 ",
      "0.28 0 0\n";
  print SES_OUT "DEVise insertWindow {User1_view} {User1}\n";

  print SES_OUT "DEVise create {window} {TileLayout} User2 0.36 0.52 0.62 ",
      "0.28 0 0\n";
  print SES_OUT "DEVise insertWindow {User2_view} {User2}\n";
}

#-----------------------------------------------------------
